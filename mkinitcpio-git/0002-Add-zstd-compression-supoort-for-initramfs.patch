From ae888b39e171f38468309ad6e310da6a8e03761a Mon Sep 17 00:00:00 2001
From: Piotr Gorski <lucjan.lucjanov@gmail.com>
Date: Wed, 26 Aug 2020 22:41:29 +0200
Subject: [PATCH] Add zstd compression supoort for initramfs

Signed-off-by: Piotr Gorski <lucjan.lucjanov@gmail.com>
---
 lsinitcpio                | 4 ++++
 man/mkinitcpio.conf.5.txt | 6 +++---
 mkinitcpio                | 3 +++
 mkinitcpio.conf           | 1 +
 4 files changed, 11 insertions(+), 3 deletions(-)

diff --git a/lsinitcpio b/lsinitcpio
index bcb4a19..4715783 100755
--- a/lsinitcpio
+++ b/lsinitcpio
@@ -113,6 +113,10 @@ detect_filetype() {
             echo 'lz4 -l'
             return
             ;;
+        fd2fb528)
+            echo 'zstd'
+            return
+            ;;
     esac
 
     read -rd '' bytes < <(hexdump -n 3 -e '"%c"' "$1")
diff --git a/man/mkinitcpio.conf.5.txt b/man/mkinitcpio.conf.5.txt
index 9c8d000..805db8c 100644
--- a/man/mkinitcpio.conf.5.txt
+++ b/man/mkinitcpio.conf.5.txt
@@ -54,9 +54,9 @@ Variables
 
 	Defines a program to filter the generated image through. As of linux 2.6.38,
 	the kernel understands the compression formats yielded by the *gzip*, *bzip2*,
-	*lz4*, *lzop*, *lzma*, and *xz* compressors. If unspecified, this setting
-	defaults to *gzip* compression. In order to create an uncompressed image, define
-	this variable as *cat*.
+	*lz4*, *lzop*, *lzma*, and *xz* compressors. Version 5.9 introduces support for *zstd*
+	compressor. If unspecified, this setting defaults to *gzip* compression.
+	In order to create an uncompressed image, define this variable as *cat*.
 +
 It's not hard to realize that a filter such as a *tac* or *rev* will cause
 *mkinitcpio* to report success but generate a useless image. Similarly, using a
diff --git a/mkinitcpio b/mkinitcpio
index ba27433..a9706d0 100755
--- a/mkinitcpio
+++ b/mkinitcpio
@@ -211,6 +211,9 @@ build_image() {
         lz4)
             COMPRESSION_OPTIONS+=('-l')
             ;;
+        zstd)
+            COMPRESSION_OPTIONS+=('-19')
+            ;;
     esac
 
     pushd "$BUILDROOT" >/dev/null
diff --git a/mkinitcpio.conf b/mkinitcpio.conf
index b926b90..ba1cce3 100644
--- a/mkinitcpio.conf
+++ b/mkinitcpio.conf
@@ -60,6 +60,7 @@ HOOKS=(base udev autodetect modconf block filesystems keyboard fsck)
 #COMPRESSION="xz"
 #COMPRESSION="lzop"
 #COMPRESSION="lz4"
+#COMPRESSION="zstd"
 
 # COMPRESSION_OPTIONS
 # Additional options for the compressor
-- 
2.28.0.89.g85b4e0a6dc

