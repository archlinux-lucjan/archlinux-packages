# Maintainer: Piotr Gorski <lucjan.lucjanov@gmail.com>
# Contributor: Ionut Biru <ibiru@archlinux.org>
# Contributor: Jan Alexander Steffens (heftig) <jan.steffens@gmail.com>

pkgbase=modemmanager-test-git
pkgname=(modemmanager-test-git libmm-glib-test-git)
pkgver=1.18.4.8.gc143f8ee
pkgrel=1
pkgdesc="Mobile broadband modem management service"
arch=(x86_64)
url="http://www.freedesktop.org/wiki/Software/ModemManager/"
license=(GPL2 LGPL2.1)
depends=(systemd libgudev polkit ppp libqmi libmbim
         mobile-broadband-provider-info)
makedepends=(gtk-doc gobject-introspection vala meson git bash-completion)
checkdepends=(python-gobject python-dbus)
source=(git://anongit.freedesktop.org/ModemManager/ModemManager#branch=mm-1-18)
sha256sums=('SKIP')

pkgver() {
  cd ModemManager

  git describe --tags | sed 's/-rc/rc/;s/-/./g'
}

prepare() {
  cd ModemManager
}

build() {
  local meson_args=(
    -D dbus_policy_dir=/usr/share/dbus-1/system.d
    -D polkit=permissive
    -D dist_version="\"$pkgver-$pkgrel\""
    -D vapi=true
    -D gtk_doc=true
  )

  arch-meson ModemManager build "${meson_args[@]}"
  meson compile -C build
}

check() {
  # Tests don't work yet
  : meson test -C build --print-errorlogs
}

_pick() {
  local p="$1" f d; shift
  for f; do
    d="$srcdir/$p/${f#$pkgdir/}"
    mkdir -p "$(dirname "$d")"
    mv "$f" "$d"
    rmdir -p --ignore-fail-on-non-empty "$(dirname "$f")"
  done
}

package_modemmanager-test-git() {
  depends+=(libmm-glib.so libg{lib,object,io,module}-2.0.so libsystemd.so libgudev-1.0.so
            libqmi-glib.so libmbim-glib.so)
  optdepends=('usb_modeswitch: install if your modem shows up as a storage drive')
  conflicts=('modemmanager')
  provides=('modemmanager')

  meson install -C build --destdir "$pkgdir"

  cd "$pkgdir"
  _pick libmm usr/include
  _pick libmm usr/lib/girepository-1.0
  _pick libmm usr/lib/libmm-glib.so*
  _pick libmm usr/lib/pkgconfig
  _pick libmm usr/share/gir-1.0
  _pick libmm usr/share/gtk-doc/html/libmm-glib
  _pick libmm usr/share/vala
}

package_libmm-glib-test-git() {
  pkgdesc="ModemManager library"
  depends=(libg{lib,object,io}-2.0.so)
  conflicts=('libmm-glib')
  provides=('libmm-glib' 'libmm-glib.so')

  mv libmm/* "$pkgdir"
}
