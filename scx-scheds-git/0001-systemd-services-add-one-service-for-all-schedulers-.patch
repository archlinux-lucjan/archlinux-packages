From 26d53233de85102c2668127d119cd39e833508b5 Mon Sep 17 00:00:00 2001
From: Piotr Gorski <lucjan.lucjanov@gmail.com>
Date: Sat, 27 Jan 2024 00:41:00 +0100
Subject: [PATCH] systemd-services: add one service for all schedulers and
 config file

Signed-off-by: Piotr Gorski <lucjan.lucjanov@gmail.com>
---
 services/meson.build          |  8 +++++++-
 services/scx                  |  5 +++++
 services/scx.service          | 14 ++++++++++++++
 services/scx_central.service  | 14 --------------
 services/scx_flatcg.service   | 14 --------------
 services/scx_nest.service     | 14 --------------
 services/scx_pair.service     | 14 --------------
 services/scx_qmap.service     | 14 --------------
 services/scx_rustland.service | 14 --------------
 services/scx_rusty.service    | 14 --------------
 services/scx_simple.service   | 14 --------------
 services/scx_userland.service | 14 --------------
 12 files changed, 26 insertions(+), 127 deletions(-)
 create mode 100644 services/scx
 create mode 100644 services/scx.service
 delete mode 100644 services/scx_central.service
 delete mode 100644 services/scx_flatcg.service
 delete mode 100644 services/scx_nest.service
 delete mode 100644 services/scx_pair.service
 delete mode 100644 services/scx_qmap.service
 delete mode 100644 services/scx_rustland.service
 delete mode 100644 services/scx_rusty.service
 delete mode 100644 services/scx_simple.service
 delete mode 100644 services/scx_userland.service

diff --git a/services/meson.build b/services/meson.build
index 1bccca8..8f86518 100644
--- a/services/meson.build
+++ b/services/meson.build
@@ -2,7 +2,7 @@ systemd_system_unit_dir = systemd.get_variable(pkgconfig : 'systemdsystemunitdir
 
   install_data(
     [
-      'scx_central.service',  'scx_flatcg.service',  'scx_nest.service',  'scx_pair.service', 'scx_qmap.service', 'scx_rustland.service',  'scx_rusty.service',  'scx_simple.service',  'scx_userland.service',
+      'scx.service',
     ],
     install_dir: systemd_system_unit_dir
   )
@@ -14,3 +14,9 @@ systemd_system_unit_dir = systemd.get_variable(pkgconfig : 'systemdsystemunitdir
     install_dir: '/etc/systemd'
   )
 
+  install_data(
+    [
+      'scx',
+    ],
+    install_dir: '/etc/default'
+  )
diff --git a/services/scx b/services/scx
new file mode 100644
index 0000000..a323de0
--- /dev/null
+++ b/services/scx
@@ -0,0 +1,5 @@
+# List of scx_schedulers: scx_central scx_flatcg scx_layered scx_nest scx_pair scx_qmap scx_rustland scx_rusty scx_simple scx_userland
+SCX_SCHEDULER=scx_rusty
+
+# Set custom flags for each scheduler, below is an example of how to use
+#SCX_FLAGS='-s 3000 -i 0.5 -I 0.025 -l 0.5 -b -k'
diff --git a/services/scx.service b/services/scx.service
new file mode 100644
index 0000000..6349a6e
--- /dev/null
+++ b/services/scx.service
@@ -0,0 +1,14 @@
+[Unit]
+Description=Start scx_scheduler
+ConditionPathIsDirectory=/sys/kernel/sched_ext
+
+[Service]
+Type=simple
+EnvironmentFile=/etc/default/scx
+ExecStart=/bin/bash -c 'exec $SCX_SCHEDULER $SCX_FLAGS '
+Restart=always
+StandardError=journal
+LogNamespace=sched-ext
+
+[Install]
+WantedBy=multi-user.target
diff --git a/services/scx_central.service b/services/scx_central.service
deleted file mode 100644
index 78c2c5f..0000000
--- a/services/scx_central.service
+++ /dev/null
@@ -1,14 +0,0 @@
-[Unit]
-Description=Start scx_central
-ConditionPathIsDirectory=/sys/kernel/sched_ext
-Conflicts=scx_flatcg.service  scx_nest.service  scx_pair.service  scx_qmap.service  scx_rustland.service  scx_rusty.service  scx_simple.service  scx_userland.service
-
-[Service]
-Type=simple
-ExecStart=scx_central
-Restart=always
-StandardError=journal
-LogNamespace=sched-ext
-
-[Install]
-WantedBy=multi-user.target
diff --git a/services/scx_flatcg.service b/services/scx_flatcg.service
deleted file mode 100644
index 8f21562..0000000
--- a/services/scx_flatcg.service
+++ /dev/null
@@ -1,14 +0,0 @@
-[Unit]
-Description=Start scx_flatcg
-ConditionPathIsDirectory=/sys/kernel/sched_ext
-Conflicts=scx_central.service  scx_nest.service  scx_pair.service  scx_qmap.service  scx_rustland.service  scx_rusty.service  scx_simple.service  scx_userland.service
-
-[Service]
-Type=simple
-ExecStart=scx_flatcg
-Restart=always
-StandardError=journal
-LogNamespace=sched-ext
-
-[Install]
-WantedBy=multi-user.target
diff --git a/services/scx_nest.service b/services/scx_nest.service
deleted file mode 100644
index b545104..0000000
--- a/services/scx_nest.service
+++ /dev/null
@@ -1,14 +0,0 @@
-[Unit]
-Description=Start scx_nest
-ConditionPathIsDirectory=/sys/kernel/sched_ext
-Conflicts=scx_central.service  scx_flatcg.service  scx_pair.service  scx_qmap.service  scx_rustland.service  scx_rusty.service  scx_simple.service  scx_userland.service
-
-[Service]
-Type=simple
-ExecStart=scx_nest
-Restart=always
-StandardError=journal
-LogNamespace=sched-ext
-
-[Install]
-WantedBy=multi-user.target
diff --git a/services/scx_pair.service b/services/scx_pair.service
deleted file mode 100644
index d792553..0000000
--- a/services/scx_pair.service
+++ /dev/null
@@ -1,14 +0,0 @@
-[Unit]
-Description=Start scx_pair
-ConditionPathIsDirectory=/sys/kernel/sched_ext
-Conflicts=scx_central.service  scx_flatcg.service  scx_nest.service  scx_qmap.service  scx_rustland.service  scx_rusty.service  scx_simple.service  scx_userland.service
-
-[Service]
-Type=simple
-ExecStart=scx_pair
-Restart=always
-StandardError=journal
-LogNamespace=sched-ext
-
-[Install]
-WantedBy=multi-user.target
diff --git a/services/scx_qmap.service b/services/scx_qmap.service
deleted file mode 100644
index 6831aee..0000000
--- a/services/scx_qmap.service
+++ /dev/null
@@ -1,14 +0,0 @@
-[Unit]
-Description=Start scx_qmap
-ConditionPathIsDirectory=/sys/kernel/sched_ext
-Conflicts=scx_central.service  scx_flatcg.service  scx_nest.service  scx_pair.service  scx_rustland.service  scx_rusty.service  scx_simple.service  scx_userland.service
-
-[Service]
-Type=simple
-ExecStart=scx_qmap
-Restart=always
-StandardError=journal
-LogNamespace=sched-ext
-
-[Install]
-WantedBy=multi-user.target
diff --git a/services/scx_rustland.service b/services/scx_rustland.service
deleted file mode 100644
index 0d5c5c5..0000000
--- a/services/scx_rustland.service
+++ /dev/null
@@ -1,14 +0,0 @@
-[Unit]
-Description=Start scx_rustland
-ConditionPathIsDirectory=/sys/kernel/sched_ext
-Conflicts=scx_central.service  scx_flatcg.service  scx_nest.service  scx_pair.service  scx_qmap.service  scx_rusty.service  scx_simple.service  scx_userland.service
-
-[Service]
-Type=simple
-ExecStart=scx_rustland
-Restart=always
-StandardError=journal
-LogNamespace=sched-ext
-
-[Install]
-WantedBy=multi-user.target
diff --git a/services/scx_rusty.service b/services/scx_rusty.service
deleted file mode 100644
index 56d219e..0000000
--- a/services/scx_rusty.service
+++ /dev/null
@@ -1,14 +0,0 @@
-[Unit]
-Description=Start scx_rusty
-ConditionPathIsDirectory=/sys/kernel/sched_ext
-Conflicts=scx_central.service  scx_flatcg.service  scx_nest.service  scx_pair.service  scx_qmap.service  scx_rustland.service  scx_simple.service  scx_userland.service
-
-[Service]
-Type=simple
-ExecStart=scx_rusty
-Restart=always
-StandardError=journal
-LogNamespace=sched-ext
-
-[Install]
-WantedBy=multi-user.target
diff --git a/services/scx_simple.service b/services/scx_simple.service
deleted file mode 100644
index ca39eec..0000000
--- a/services/scx_simple.service
+++ /dev/null
@@ -1,14 +0,0 @@
-[Unit]
-Description=Start scx_simple
-ConditionPathIsDirectory=/sys/kernel/sched_ext
-Conflicts=scx_central.service  scx_flatcg.service  scx_nest.service  scx_pair.service  scx_qmap.service  scx_rustland.service  scx_rusty.service  scx_userland.service
-
-[Service]
-Type=simple
-ExecStart=scx_simple
-Restart=always
-StandardError=journal
-LogNamespace=sched-ext
-
-[Install]
-WantedBy=multi-user.target
diff --git a/services/scx_userland.service b/services/scx_userland.service
deleted file mode 100644
index 984068e..0000000
--- a/services/scx_userland.service
+++ /dev/null
@@ -1,14 +0,0 @@
-[Unit]
-Description=Start scx_userland
-ConditionPathIsDirectory=/sys/kernel/sched_ext
-Conflicts=scx_central.service  scx_flatcg.service  scx_nest.service  scx_pair.service  scx_qmap.service  scx_rustland.service  scx_rusty.service  scx_simple.service
-
-[Service]
-Type=simple
-ExecStart=scx_userland
-Restart=always
-StandardError=journal
-LogNamespace=sched-ext
-
-[Install]
-WantedBy=multi-user.target
-- 
2.43.0.232.ge79552d197

