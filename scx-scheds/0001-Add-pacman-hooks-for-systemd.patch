From 1fbf4f4f9b0e3dedcb9be25dcabc84a8bfa6fa50 Mon Sep 17 00:00:00 2001
From: Piotr Gorski <lucjan.lucjanov@gmail.com>
Date: Mon, 13 May 2024 15:52:06 +0200
Subject: [PATCH] Add pacman hooks for systemd

Signed-off-by: Piotr Gorski <lucjan.lucjanov@gmail.com>
---
 libalpm/systemd/90-scx-scheds-upgrade.hook | 19 +++++++++++++++++++
 libalpm/systemd/meson.build                |  4 ++++
 libalpm/systemd/scx-systemd-restart        | 12 ++++++++++++
 meson.build                                |  6 ++++++
 meson.options                              |  6 ++++++
 5 files changed, 47 insertions(+)
 create mode 100644 libalpm/systemd/90-scx-scheds-upgrade.hook
 create mode 100644 libalpm/systemd/meson.build
 create mode 100755 libalpm/systemd/scx-systemd-restart

diff --git a/libalpm/systemd/90-scx-scheds-upgrade.hook b/libalpm/systemd/90-scx-scheds-upgrade.hook
new file mode 100644
index 0000000..2f568e8
--- /dev/null
+++ b/libalpm/systemd/90-scx-scheds-upgrade.hook
@@ -0,0 +1,19 @@
+[Trigger]
+Type = Path
+Operation = Upgrade
+Target = etc/default/scx
+Target = etc/systemd/journald@sched-ext.conf
+Target = usr/bin/scx_*
+Target = usr/lib/systemd/system/scx.service
+
+[Trigger]
+Type = Package
+Operation = Upgrade
+Target = scx-scheds
+Target = scx-scheds-git
+
+[Action]
+Description = Checking scx_scheduler...
+When = PostTransaction
+Exec = /usr/share/libalpm/scripts/scx-systemd-restart
+NeedsTargets
diff --git a/libalpm/systemd/meson.build b/libalpm/systemd/meson.build
new file mode 100644
index 0000000..34dc622
--- /dev/null
+++ b/libalpm/systemd/meson.build
@@ -0,0 +1,4 @@
+# Install the 'scx-systemd-restart' file to the '/usr/share/libalpm/scripts' directory
+install_data('scx-systemd-restart', install_dir: '/usr/share/libalpm/scripts')
+# Install the '90-scx-scheds-upgrade.hook' file to the '/usr/share/libalpm/hooks' directory
+install_data('90-scx-scheds-upgrade.hook', install_dir: '/usr/share/libalpm/hooks')
diff --git a/libalpm/systemd/scx-systemd-restart b/libalpm/systemd/scx-systemd-restart
new file mode 100755
index 0000000..7c2e93f
--- /dev/null
+++ b/libalpm/systemd/scx-systemd-restart
@@ -0,0 +1,12 @@
+#!/usr/bin/env bash
+# SPDX-License-Identifier: GPL-2.0-only
+
+# Check the status of the service
+if systemctl is-active --quiet scx.service; then
+    echo "The service is active. Restarting..."
+    systemctl daemon-reload
+    systemctl restart scx.service
+    echo "Service has been restarted."
+else
+    echo "The service is not active."
+fi
diff --git a/meson.build b/meson.build
index d00a4a8..93c3444 100644
--- a/meson.build
+++ b/meson.build
@@ -327,3 +327,9 @@ openrc = dependency('openrc', required: get_option('openrc'))
 if openrc.found()
   subdir('services/openrc')
 endif
+
+libalpm = dependency('libalpm', required: get_option('libalpm'))
+
+if libalpm.found() and systemd.found()
+  subdir('libalpm/systemd')
+endif
diff --git a/meson.options b/meson.options
index 087abf2..68efa11 100644
--- a/meson.options
+++ b/meson.options
@@ -30,3 +30,9 @@ option(
   value: 'auto',
   description: 'openrc init.d service file'
 )
+option(
+  'libalpm',
+  type: 'feature',
+  value: 'auto',
+  description: 'install pacman hooks'
+)
-- 
2.44.0.325.g11c821f2f2

