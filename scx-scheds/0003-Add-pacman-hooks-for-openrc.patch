From 951a3d66bcb149254c16aee954ca4eb793f92d67 Mon Sep 17 00:00:00 2001
From: Piotr Gorski <lucjan.lucjanov@gmail.com>
Date: Mon, 20 May 2024 08:32:05 +0200
Subject: [PATCH] Add pacman hooks for openrc

Signed-off-by: Piotr Gorski <lucjan.lucjanov@gmail.com>
---
 libalpm/openrc/90-scx-scheds-upgrade.hook | 19 +++++++++++++++++++
 libalpm/openrc/meson.build                |  4 ++++
 libalpm/openrc/scx-openrc-restart         | 11 +++++++++++
 meson.build                               |  4 ++++
 4 files changed, 38 insertions(+)
 create mode 100644 libalpm/openrc/90-scx-scheds-upgrade.hook
 create mode 100644 libalpm/openrc/meson.build
 create mode 100755 libalpm/openrc/scx-openrc-restart

diff --git a/libalpm/openrc/90-scx-scheds-upgrade.hook b/libalpm/openrc/90-scx-scheds-upgrade.hook
new file mode 100644
index 0000000..678f84e
--- /dev/null
+++ b/libalpm/openrc/90-scx-scheds-upgrade.hook
@@ -0,0 +1,19 @@
+[Trigger]
+Type = Path
+Operation = Upgrade
+Target = etc/conf.d/scx
+Target = etc/default/scx
+Target = etc/init.d/scx
+Target = usr/bin/scx_*
+
+[Trigger]
+Type = Package
+Operation = Upgrade
+Target = scx-scheds
+Target = scx-scheds-git
+
+[Action]
+Description = Checking scx_scheduler...
+When = PostTransaction
+Exec = /usr/share/libalpm/scripts/scx-openrc-restart
+NeedsTargets
diff --git a/libalpm/openrc/meson.build b/libalpm/openrc/meson.build
new file mode 100644
index 0000000..83ee99c
--- /dev/null
+++ b/libalpm/openrc/meson.build
@@ -0,0 +1,4 @@
+# Install the 'scx-openrc-restart' file to the '/usr/share/libalpm/scripts' directory
+install_data('scx-openrc-restart', install_dir: '/usr/share/libalpm/scripts')
+# Install the '90-scx-scheds-upgrade.hook' file to the '/usr/share/libalpm/hooks' directory
+install_data('90-scx-scheds-upgrade.hook', install_dir: '/usr/share/libalpm/hooks')
diff --git a/libalpm/openrc/scx-openrc-restart b/libalpm/openrc/scx-openrc-restart
new file mode 100755
index 0000000..c3a9ad8
--- /dev/null
+++ b/libalpm/openrc/scx-openrc-restart
@@ -0,0 +1,11 @@
+#!/usr/bin/env bash
+# SPDX-License-Identifier: GPL-2.0-only
+
+# Check the status of the service
+if /etc/init.d/scx status > /dev/null; then
+    echo "The service is active. Restarting..."
+    /usr/bin/rc-service scx restart
+    echo "Service has been restarted."
+else
+    echo "The service is not active."
+fi
diff --git a/meson.build b/meson.build
index 8583244..475e182 100644
--- a/meson.build
+++ b/meson.build
@@ -338,3 +338,7 @@ libalpm = dependency('libalpm', required: get_option('libalpm'))
 if libalpm.found() and systemd.found()
   subdir('libalpm/systemd')
 endif
+
+if libalpm.found() and openrc.found()
+  subdir('libalpm/openrc')
+endif
-- 
2.45.1.145.g83f1add914

